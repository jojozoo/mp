<link rel="stylesheet" type="text/css" href="/uploadify/uploadify.css">
<!-- <link rel="stylesheet" type="text/css" href="/uploadify/jquery.imgareaselect.css" />
<script type="text/javascript" src="/uploadify/jquery.uploadify.js"></script>
<script type="text/javascript" src="/uploadify/jquery.imgareaselect.js"></script>
<script type="text/javascript" src="/uploadify/uploadify-avatar.js"></script> -->

<link href="/uploadie/jcrop.css?v=<%= Time.now.to_i %>" media="all" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/uploadie/jcrop.js?v=<%= Time.now.to_i %>"></script>

<div class="row">
	<div class="col-md-5">
		<div class="avatar-browse">
			<%= image_tag current_user.avatar.url, id: 'preview' %>
		</div>
	</div>
	<div class="col-md-7">
		<div class="row">
			<p class="text-left" style="margin-left: 15px;">您上传的图片将自动生成3种尺寸头像，请注意中小尺寸的头像是否清晰</p>
		</div>
		<div class="row">
			<div class="col-md-6">
				<div class="review s200">
					<%= image_tag current_user.avatar.url, class: 's200' %>
				</div>
			</div>
			<div class="col-md-6">
				<div class="row">
					<div class="review s100">
						<%= image_tag current_user.avatar.url, class: 's100' %>
					</div>
				</div>
				<div class="row" style="margin-top: 40px">
					<div class="review s50">
						<%= image_tag current_user.avatar.url, class: 's50' %>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<hr>
<div class="row">
	<div class="col-md-12">
		<%= form_tag "/my/set/cut", enctype: 'multipart/form-data' %>
			<input type="hidden" id='c_x' name='x'>
			<input type="hidden" id='c_y' name='y'>
			<input type="hidden" id='c_w' name='w'>
			<input type="hidden" id='c_h' name='h'>
			<input type="file" name="file" accept="image/*" onchange="choose_file();" id="cf">
			<input type="submit" class="disabled btn btn-primary" id='upload_file' value='选择文件' style="width: 120px;">
		</form>
	</div>
</div>
<style type="text/css">
.avatar-browse{
	width: 300px;
	height: 300px;
}
.avatar-browse img{
	max-width: 100%;
	max-height: 100%;
}
</style>
<script type="text/javascript">
	function choose_file(){
		var image = document.getElementById("preview");
		var file  = document.getElementById("cf");
		var ext   = file.value.substring(file.value.lastIndexOf(".")+1).toLowerCase();
		// gif在IE浏览器暂时无法显示
		if(ext != 'png' && ext!= 'jpg' && ext != 'jpeg'){
		 	alert("只允许png jpg的图片");
		 	return;
		}
		// IE浏览器
		if (document.all) {
			file.select();
			var path = document.selection.createRange().text;
			var isIE6 = /msie 6/i.test(navigator.userAgent);
			// IE6浏览器设置img的src为本地路径可以直接显示图片
			if (isIE6){
				image.src = path;
			} else { 
				// 非IE6版本的IE由于安全问题直接设置img的src无法显示本地图片，但是可以通过滤镜来实现
				image.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image',src=\"" + path + "\")";
				// 设置img的src为base64编码的透明图片 取消显示浏览器默认图片
				image.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
			}
		} else {
			var file = file.files[0]; 
			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function(e){
				image.src = this.result;
			} 
		}
		var jcrop;
		// jcrop.destroy()
		jcrop = $("#preview").Jcrop({aspectRatio: 1, onChange: function(){}});
	}
	function showPreview(coords){
		var rx = 100 / coords.w;
		var ry = 100 / coords.h;

		$('#preview').css({
			width: Math.round(rx * 500) + 'px',
			height: Math.round(ry * 370) + 'px',
			marginLeft: '-' + Math.round(rx * coords.x) + 'px',
			marginTop: '-' + Math.round(ry * coords.y) + 'px'
		});
	}
</script>